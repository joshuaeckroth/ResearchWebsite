<?php

/**
 * Valid permissions for this module
 * @return array An array of valid permissions
 */
function note_pdf_perm() {
  return array('download pdf');
}

function note_pdf_menu() {
  $items['node/%node/pdf'] = array(
    'title' => 'PDF',
    'page callback' => 'note_pdf_tab_page',
    'page arguments' => array(1),
    'access callback' => 'note_pdf_tab_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

function note_pdf_tab_access($node = NULL) {
  if($node->type == 'page')
    return TRUE;
  return FALSE;
}

function note_pdf_tab_page($node = NULL) {
  drupal_set_title(t('PDF export of %title', array('%title' => $node->title)));

  $output = drupal_get_form('note_pdf_tab_form', $node);
  return $output;
}

function note_pdf_tab_form($form_state, &$node) {
  $form['#tab'] = TRUE;
  $form['node'] = array(
    '#type' => 'value',
    '#value' => $node,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Download PDF')
  );
  return $form;
}

function note_pdf_tab_form_submit($form, &$form_state) {
  global $base_url;

  $node = node_build_content($form_state['values']['node'], FALSE, FALSE);
  $content = drupal_render($node->content);
  $node->body = $content;
  unset($node->teaser);
  node_invoke_nodeapi($node, 'alter', FALSE, FALSE);

  $uid = $node->uid;
  $result = db_query("SELECT title FROM {node} n WHERE n.type = 'uprofile' AND n.uid = %d", $uid);
  $author = db_fetch_object($result);

  $keywords = array();
  foreach ($node->taxonomy as $term) {
    $keywords []= $term->name;
  }

  $path = drupal_get_path_alias('node/'.$node->nid, isset($node->language) ? $node->language : '');
  $path = preg_replace('/\//', '--', $path);

  $tex = file_destination(file_create_path(file_directory_temp() . '/' . $path . ".tex"),
                          FILE_EXISTS_RENAME);
  $pdf = preg_replace('/\.tex$/', '.pdf', $tex);

  $tex_handle = fopen($tex, "w");
  fwrite($tex_handle, '\documentclass{article}');
  fwrite($tex_handle, '\usepackage[colorlinks=false,pdftex,pdfborder={0 0 0},pdfauthor={'.
    $author->title.'},pdftitle={'.$node->title.'},pdfkeywords={'.implode(", ", $keywords).'}]{hyperref}');
  fwrite($tex_handle, '\usepackage[margin=1in]{geometry}');
  fwrite($tex_handle, '\usepackage{palatino}');
  fwrite($tex_handle, '\usepackage{setspace}\doublespacing');
  fwrite($tex_handle, '\setlength{\parindent}{0em}');
  fwrite($tex_handle, '\setlength{\parskip}{1em}');
  fwrite($tex_handle, '\title{'.$node->title.'}');
  fwrite($tex_handle, '\author{'.$author->title.'}');
  fwrite($tex_handle, '\date{'.format_date($node->changed, 'custom', 'F j, Y').'}');
  fwrite($tex_handle, '\begin{document}');

  fwrite($tex_handle, '\maketitle ');

  $body = $node->body;

  // remove "summarizes" junk
  $body = preg_replace('/<div class="field field-type-nodereference field-field-note-summarizes">.*/s', '', $body);

  /* find references */
  $citekeys = array();
  $bibentries = array();
  preg_match_all('/<a.*?href=\"\/resource\/(.*?)\"/', $body, $matches, PREG_SET_ORDER);
  foreach ($matches as $match) {
    $citekeys []= $match[1];
  }
  $citekeys = array_unique($citekeys);
  foreach ($citekeys as $citekey) {
    $bibentries []= _biblio_citekey_print($citekey);
  }
  sort($bibentries);

  $body .= "<p><strong>References</strong></p>";
  $body .= "\\raggedright\n";
  $body .= "\\leftskip 1em\n\\parindent -1em\n";
  $body .= implode("\n\n", $bibentries);

  $body = preg_replace('/&nbsp;/', ' ', $body);
  $body = preg_replace('/<p>/', "\n\n", $body);
  $body = preg_replace('/<\/p>/', "\n\n", $body);
  $body = preg_replace('/<br.*?>/', "\\\\\\\\", $body);
  $body = preg_replace('/<strong>(.*?)<\/strong>/', '\textbf{$1}', $body);
  $body = preg_replace('/<em>(.*?)<\/em>/', '\emph{$1}', $body);
  $body = preg_replace('/<i>(.*?)<\/i>/', '\emph{$1}', $body);
  $body = preg_replace('/<u>(.*?)<\/u>/', '\emph{$1}', $body);
  $body = preg_replace('/<blockquote>/', '\begin{quote}', $body);
  $body = preg_replace('/<\/blockquote>/', '\end{quote}', $body);
  $body = preg_replace('/<\/?span.*?>/', '', $body);
  $body = preg_replace('/<ul>/', '\begin{itemize}', $body);
  $body = preg_replace('/<\/ul>/', '\end{itemize}', $body);
  $body = preg_replace('/<ol>/', '\begin{enumerate}', $body);
  $body = preg_replace('/<\/ol>/', '\end{enumerate}', $body);
  $body = preg_replace('/<li>(.*?)<\/li>/', '\item {$1}', $body);
  $body = preg_replace_callback('/<a href="(.*?)">(.*?)<\/a>/', 'href_to_hyperref', $body);
  $body = preg_replace("/(\\s)(?:'|&#039;)(\\S)/", '$1`$2', $body);
  $body = preg_replace("/&#039;(\"|&quot;)/", "' ''", $body);
  $body = preg_replace('/&#039;/', "'", $body); 
  $body = preg_replace('/(\s)(?:"|&quot;)(\S)/', '$1``$2', $body);
  $body = preg_replace('/(\S)(?:"|&quot;)/', "\$1''", $body);
  $body = preg_replace('/\|/', '$|$', $body);
  $body = preg_replace('/\x{00E0}/u', "\\`{a}", $body);
  $body = preg_replace('/\x{2013}/u', '--', $body);
  $body = preg_replace('/\x{2014}/u', '---', $body);
  $body = preg_replace('/<!--(.*?)-->/', '', $body);
  $body = preg_replace('/&amp;/', '\&', $body);
  $body = preg_replace('/%/', '\%', $body);
  $body = preg_replace('/(\d+)--(\d+)/', '$1\mbox{--}$2', $body); // keep digits with ndash on same line

  fwrite($tex_handle, $body);

  fwrite($tex_handle, '\end{document}');

  exec('pdflatex -output-directory /tmp ' . $tex);
  
  $file = basename($pdf);

  $headers[] = "Content-Type: application/pdf";
  $headers[] = "Content-Disposition: attachment; filename=\"".$file."\"";

  file_transfer($pdf, $headers);
}

function href_to_hyperref($matches)
{
  global $base_url;

  if(substr($matches[1], 0, 1) == "/") {
    return '\href{'.$base_url.$matches[1].'}{'.$matches[2].'}';
  } else {
    return '\href{'.$matches[1].'}{'.$matches[2].'}';
  }
}
